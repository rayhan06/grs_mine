<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="dashboardCentralIncludeStyle" th:remove="tag">
    <link href="/assets/global/plugins/select2/css/select2.min.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/global/plugins/select2/css/select2-bootstrap.min.css" rel="stylesheet" type="text/css"/>
</div>

<div class="page-content" th:fragment="dashboardCentral">
    <div class="row note note-success">
        <div class="col-sm-3"></div>
        <div class="col-sm-6 text-center "><span class="font-lg font-purple">সকল দপ্তরের বর্তমান মাসের সামগ্রিক পরিসংখ্যান</span></div>
        <div class="col-sm-3 text-center"><span class="grey-mint" th:classappend="${!isMobileLogin ? 'btn pull-right' : ''}" style="cursor: default;" th:text="${currentMonthYear}"></span></div>
    </div>
    <div class="central-dashboard">
        <div class="row">
            <div class="col-lg-12 col-xs-12 col-sm-12">
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="icon-microphone font-dark hide"></i>
                            <span class="caption-subject bold font-white uppercase text-center">অভিযোগ নিষ্পত্তি</span>
                            <span class="caption-helper"></span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="row">
                            <div class="portlet box" th:style="${isMobileLogin ? 'margin-bottom: 0px!important;' : ''}">
                                <div class="portlet-body">
                                    <div class="row">
                                        <div class="col-sm-4" th:classappend="${isMobileLogin ? 'margin-bottom-10' : ''}">
                                            <span class="dashboard-stat dashboard-stat-v2 blue">
                                                <div class="visual">
                                                    <i class="fa fa-balance-scale"></i>
                                                </div>
                                                <div class="details col-md-6" id="central-box-1">
                                                    <div class="number">
                                                        <span class="value" data-counter="counterup" data-value="0">০</span> টি
                                                    </div>
                                                    <div class="desc">প্রাপ্ত অভিযোগ</div>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="col-sm-4" th:classappend="${isMobileLogin ? 'margin-bottom-10' : ''}">
                                            <span class="dashboard-stat dashboard-stat-v2 green">
                                                <div class="visual">
                                                    <i class="fa fa-gavel"></i>
                                                </div>
                                                <div class="details" id="central-box-2">
                                                    <div class="number">
                                                        <span class="value" data-counter="counterup" data-value="0">০</span> টি
                                                    </div>
                                                    <div class="desc">নিষ্পত্তিকৃত অভিযোগ</div>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="col-sm-4" th:classappend="${isMobileLogin ? 'margin-bottom-10' : ''}">
                                            <span class="dashboard-stat dashboard-stat-v2 purple">
                                                <div class="visual">
                                                    <i class="fa fa-bar-chart-o"></i>
                                                </div>
                                                <div class="details" id="central-box-3">
                                                    <div class="number">
                                                        <span class="value" data-counter="counterup" data-value="0">০</span> %
                                                    </div>
                                                    <div class="desc">নিষ্পত্তির হার</div>
                                                </div>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <a class="btn btn-block blue" th:classappend="${!isMobileLogin ? 'btn-lg' : ''}" data-toggle="modal" href="#modalSubOfficesDashboard" style="display: inline-block;">
                                    <i class="fa fa-sitemap"></i>&nbsp;
                                    <span> যেকোনো দপ্তরের ড্যাশবোর্ড দেখতে এখানে ক্লিক করুন </span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="portlet box purple">
                    <div class="portlet-title">
                        <div class="caption text-center">
                            <span> মন্ত্রণালয়/বিভাগ পর্যায়ের দপ্তরসমূহের পরিসংখ্যান </span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <table id="ministryOfficesStatistics" class="table table-responsive table-striped table-bordered">
                            <thead>
                            <tr>
                                <th class="text-center"> ক্রমিক </th>
                                <th class="text-center"> মন্ত্রণালয়/বিভাগ </th>
                                <th class="text-center"> প্রাপ্ত অভিযোগ </th>
                                <th class="text-center"> অভিযোগ নিষ্পত্তি </th>
                                <th class="text-center"> নিষ্পত্তির হার (%) </th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="portlet box red">
                    <div class="portlet-title">
                        <div class="caption text-center">
                            <span>বর্তমান মাসে সর্বাধিক অভিযুক্ত ১০ টি সেবার তালিকা</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <table class="table top-n-grievances table-responsive table-striped table-hover table-bordered">
                            <thead>
                            <tr>
                                <th class="text-center">ক্রমিক</th>
                                <th class='text-center'>সেবার নাম</th>
                                <th class='text-center'>অভিযোগের সংখ্যা</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalOfficeWiseGrievanceCountForService" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title font-blue text-center">
                        <span class="bold">সেবার নাম: </span>
                        <span class="title-service-name"></span>
                    </h4>
                </div>
                <div th:classappend="${!isMobileLogin ? 'modal-body' : ''}">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            <thead>
                            <tr>
                                <th class="text-center"> ক্রমিক </th>
                                <th class="text-center"> দপ্তর </th>
                                <th class="text-center"> অভিযোগের সংখ্যা </th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn dark btn-outline" data-dismiss="modal">বন্ধ করুন</button>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="dashboard/subOfficeSelectionPopup :: subOfficeSelectionPopup"></div>
</div>

<div th:fragment="dashboardCentralIncludeScript" th:remove="tag">
    <div th:replace="dashboard/subOfficeSelectionPopup :: subOfficeSelectionPopupScript" th:remove="tag"></div>
    <script src="/assets/global/plugins/select2/js/select2.full.min.js" type="text/javascript"></script>
</div>

<script type="text/javascript" th:fragment="dashboardCentralScript">

    function popupLoadingFailureMessage() {
        toastr.error("দুঃখিত! ত্রুটির জন্য দেখানো যাচ্ছেনা", null, {positionClass: 'toast-top-center'});
    }

    function encodeOfficeIdOnDrillDown(param) {
        var encodedPrefix = btoa("" + (Math.pow(10,10) * Math.random())).substr(0,20).split("").reverse().join("");
        var encodedParams = btoa("" + param);
        return encodedPrefix + encodedParams;
    }

    function loadCentralDashboardData() {
        var isEnglish = (languageCode == "en");
        blockUI();
        $.getJSON("/api/dashboard/central-data", function (response) {
            var total = response.total;
            var resolved = response.resolved;
            var rate = 0;
            if(total > 0) {
                var result = (resolved / total) * 100;
                rate = Math.round(result * 100) / 100;
            }
            $("#central-box-1 .value").text(("" + total).toBanglaNumber());
            $("#central-box-2 .value").text(("" + resolved).toBanglaNumber());
            $("#central-box-3 .value").text(("" + rate).toBanglaNumber());

            var grievanceList = response.grievanceListDTO;
            var tbody = "";
            var rowTitle = isEnglish ? "Click to view count by offices" : "দপ্তর অনুযায়ী সেবাটির অভিযোগ সংখ্যা দেখতে ক্লিক করুন";
            if(grievanceList.length > 0) {
                grievanceList.forEach(function (item, index) {
                    tbody += "<tr data-id='" + item.id + "' title='" + rowTitle + "' data-toggle='tooltip' style='cursor:pointer;'>" +
                        "<td class='text-center'>" + ("" + (index + 1)).toBanglaNumber() + "</td>" +
                        "<td class='service-name'>" + item.name + "</td>" +
                        "<td class='text-center'>" + ("" + item.grievanceCount).toBanglaNumber() + "</td>" +
                        "</tr>";
                });
            } else {
                var message = isEnglish ? "Sorry! no records found" : "দূঃখিত! কোনো তথ্য পাওয়া যায়নি";
                tbody = "<tr><td colspan='3' class='text-center'>" + message + "</td></tr>";
            }
            var tbodyDom = $("table.top-n-grievances tbody");
            tbodyDom.empty().html(tbody);
            tbodyDom.find("[data-toggle='tooltip']").tooltip();
        }).always(function () {
            unblockUI();
        });
    }

    function blockUI() {
        var isEnglish = (languageCode == "en");
        var msg = isEnglish ? "Just a moment" : "দয়া করে অপেক্ষা করুন" ;
        $.blockUI({
            message: '<h1>' + msg + '</h1>'
        });
    }

    function unblockUI() {
        $.unblockUI();
    }

    function viewServicesGrievenceCountByOffices() {
        $("table.top-n-grievances tbody").on("click", "tr", function () {
            var _this = $(this),
                serviceId = _this.attr("data-id"),
                serviceName = _this.find("td.service-name").text(),
                isEnglish = (languageCode == "en"),
                tbody = "";
            $.ajax({
                url: "/api/dashboard/central-dashboard/services/" + serviceId + "/count-by-office",
                type: "GET",
                dataType: "json",
                success: function(response) {
                    if(response && response.length > 0) {
                        response.forEach(function (item, index) {
                            tbody += "<tr data-id='" + item.id + "'>" +
                                "<td class='text-center'>" + ("" + (index + 1)).toBanglaNumber() + "</td>" +
                                "<td class='text-center office-name'>" + item.name + "</td>" +
                                "<td class='text-center'>" + ("" + item.grievanceCount).toBanglaNumber() + "</td>" +
                                "</tr>";
                        });
                    } else {
                        tbody = "<tr><td colspan='3' class='text-center'>" + (isEnglish ? "Sorry! no records found" : "দূঃখিত! কোনো তথ্য পাওয়া যায়নি") + "</td></tr>";
                    }
                    var modal = $("#modalOfficeWiseGrievanceCountForService");
                    modal.find(".title-service-name").text(serviceName);
                    modal.find("table tbody").html($(tbody));
                    modal.modal("show");
                },
                beforeSend: function () {
                    blockUI();
                },
                complete: function () {
                    unblockUI();
                }
            });
        });
    }

    function showMinistryLevelOfficesStatistics() {
        $.ajax({
            url: "/api/dashboard/central-dashboard/count-by-all-ministries",
            type: "GET",
            dataType: "json",
            success: function(response) {
                var tbody = "";
                if(response && response.length > 0) {
                    response.forEach(function (item, index) {
                        var resolved = item.resolvedCount;
                        var total = item.totalCount;
                        var rate = item.rate;
                        tbody += "<tr>" +
                            "<td class='text-center'>" + ("" + (index + 1)).toBanglaNumber() + "</td>" +
                            "<td class='text-center'><a href='dashboard.do?params=" + encodeOfficeIdOnDrillDown(item.officeId) + "' class='blueLink' title='ড্যাশবোর্ড দেখুন' data-toggle='tooltip'>" + item.officeName + "</a></td>" +
                            "<td class='text-center'>" + ("" + total).toBanglaNumber() + "</td>" +
                            "<td class='text-center'>" + ("" + resolved).toBanglaNumber() + "</td>" +
                            "<td class='text-center'>" + (total > 0 ? ("" + rate).toBanglaNumber() : "-") + "</td>" +
                            "</tr>";
                    });
                } else {
                    tbody = "<tr><td colspan='3' class='text-center'>" + (isEnglish ? "Sorry! no records found" : "দূঃখিত! কোনো তথ্য পাওয়া যায়নি") + "</td></tr>";
                }
                var tbodyDom = $("#ministryOfficesStatistics tbody");
                tbodyDom.empty().html($(tbody));
                tbodyDom.find("[data-toggle='tooltip']").tooltip();
            },
            beforeSend: function () {
                blockUI();
            },
            complete: function () {
                unblockUI();
            }
        });
    }

    $(document).ready(function(){
        loadCentralDashboardData();
        viewServicesGrievenceCountByOffices();
        showMinistryLevelOfficesStatistics();
        bindOfficeLayersChangeActions("");
        $("#header_central_dashboard a").addClass("active");
    });
</script>